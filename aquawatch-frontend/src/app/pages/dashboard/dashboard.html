<div class="dashboard-container">
  <!-- Header -->
  <div class="dashboard-header animate-fade-in-down">
    <div class="header-content">
      <h1 class="dashboard-title">
        <span class="title-icon animate-float">
          <i class="bi bi-droplet-fill"></i>
        </span>
        <span class="text-gradient">AquaWatch Dashboard</span>
      </h1>
      <p class="dashboard-subtitle">Surveillance de la qualité de l'eau en temps réel</p>
    </div>
    <div class="header-actions">
      <div class="last-update-badge">
        <i class="bi bi-clock"></i>
        <span>{{ lastUpdate | date:'HH:mm:ss' }}</span>
      </div>
      <button class="btn btn-primary ripple-effect" (click)="refreshData()" [disabled]="loading">
        <i class="bi bi-arrow-clockwise" [class.spin]="loading"></i>
        <span>Rafraîchir</span>
      </button>
    </div>
  </div>

  <!-- Stats Cards -->
  <div class="stats-row">
    <div class="stat-card animate-fade-in-up stagger-1" (click)="navigateTo('/stations/list')">
      <div class="stat-icon-wrapper gradient-primary">
        <i class="bi bi-geo-alt-fill"></i>
      </div>
      <div class="stat-content">
        <span class="stat-number">{{ totalStations }}</span>
        <span class="stat-label">Stations totales</span>
      </div>
      <div class="stat-trend up">
        <i class="bi bi-arrow-up-right"></i>
      </div>
    </div>

    <div class="stat-card animate-fade-in-up stagger-2">
      <div class="stat-icon-wrapper gradient-success">
        <i class="bi bi-check-circle-fill"></i>
      </div>
      <div class="stat-content">
        <span class="stat-number">{{ goodStations }}</span>
        <span class="stat-label">Qualité bonne</span>
      </div>
      <div class="stat-progress">
        <div class="progress-bar success" [style.width.%]="totalStations ? (goodStations/totalStations)*100 : 0"></div>
      </div>
    </div>

    <div class="stat-card animate-fade-in-up stagger-3">
      <div class="stat-icon-wrapper gradient-warning">
        <i class="bi bi-exclamation-triangle-fill"></i>
      </div>
      <div class="stat-content">
        <span class="stat-number">{{ moderateStations }}</span>
        <span class="stat-label">Qualité modérée</span>
      </div>
      <div class="stat-progress">
        <div class="progress-bar warning" [style.width.%]="totalStations ? (moderateStations/totalStations)*100 : 0"></div>
      </div>
    </div>

    <div class="stat-card animate-fade-in-up stagger-4">
      <div class="stat-icon-wrapper gradient-danger">
        <i class="bi bi-x-circle-fill"></i>
      </div>
      <div class="stat-content">
        <span class="stat-number">{{ badStations }}</span>
        <span class="stat-label">Qualité mauvaise</span>
      </div>
      <div class="stat-progress">
        <div class="progress-bar danger" [style.width.%]="totalStations ? (badStations/totalStations)*100 : 0"></div>
      </div>
    </div>

    <div class="stat-card animate-fade-in-up stagger-5 alert-card" (click)="navigateTo('/alerts')">
      <div class="stat-icon-wrapper gradient-danger animate-pulse">
        <i class="bi bi-bell-fill"></i>
      </div>
      <div class="stat-content">
        <span class="stat-number">{{ activeAlerts }}</span>
        <span class="stat-label">Alertes actives</span>
      </div>
      @if (activeAlerts > 0) {
        <div class="alert-indicator"></div>
      }
    </div>
  </div>

  <!-- Loading Spinner -->
  @if (loading) {
    <div class="loading-overlay">
      <div class="loading-spinner">
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
        <div class="spinner-ring"></div>
        <i class="bi bi-droplet-fill spinner-icon"></i>
      </div>
      <p class="loading-text">Chargement des données...</p>
    </div>
  }

  <!-- Error Message -->
  @if (error) {
    <div class="alert alert-danger animate-fade-in" role="alert">
      <i class="bi bi-exclamation-triangle me-2"></i> {{ error }}
      <button class="btn btn-sm btn-outline-danger ms-3" (click)="refreshData()">
        <i class="bi bi-arrow-clockwise"></i> Réessayer
      </button>
    </div>
  }

  <!-- Main Content -->
  <div class="main-content" [class.loading-content]="loading">
    <div class="row g-4">
      <!-- Charts Section -->
      <div class="col-lg-4 animate-slide-in-left">
        <div class="card chart-card hover-lift">
          <div class="card-header">
            <div class="card-header-icon">
              <i class="bi bi-pie-chart-fill"></i>
            </div>
            <h5>Répartition de la qualité</h5>
          </div>
          <div class="card-body">
            <canvas baseChart
              [data]="qualityPieChartData"
              [options]="qualityPieChartOptions"
              type="pie">
            </canvas>
          </div>
        </div>
      </div>

      <div class="col-lg-8 animate-slide-in-right">
        <div class="card chart-card hover-lift">
          <div class="card-header">
            <div class="card-header-icon">
              <i class="bi bi-bar-chart-fill"></i>
            </div>
            <h5>Scores WQI par station</h5>
          </div>
          <div class="card-body">
            <canvas baseChart
              [data]="scoreBarChartData"
              [options]="scoreBarChartOptions"
              type="bar">
            </canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4 mt-2">
      <!-- Stations Table -->
      <div class="col-lg-7 animate-fade-in-up">
        <div class="card stations-table-card hover-lift">
          <div class="card-header d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center">
              <div class="card-header-icon">
                <i class="bi bi-list-ul"></i>
              </div>
              <h5>Stations de surveillance</h5>
            </div>
            <a routerLink="/stations" class="btn btn-sm btn-outline-primary ripple-effect">
              <i class="bi bi-map me-1"></i> Voir la carte
            </a>
          </div>
          <div class="card-body table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Code</th>
                  <th>Nom</th>
                  <th>Score</th>
                  <th>Status</th>
                  <th>Alerte</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let station of stations; let i = index" 
                    class="table-row-animated"
                    [style.animation-delay.ms]="i * 50"
                    [class.row-danger]="station.currentStatus === 'BAD'"
                    [class.row-warning]="station.currentStatus === 'MODERATE'">
                  <td><strong class="station-code">{{ station.code }}</strong></td>
                  <td>{{ station.name }}</td>
                  <td>
                    <div class="score-badge" [class]="'score-' + station.currentStatus?.toLowerCase()">
                      {{ station.currentScore | number:'1.0-0' }}
                    </div>
                  </td>
                  <td>
                    <span class="status-badge" [class]="'status-' + station.currentStatus?.toLowerCase()">
                      {{ getStatusLabel(station.currentStatus) }}
                    </span>
                  </td>
                  <td>
                    <span *ngIf="station.hasActiveAlert" class="alert-badge animate-pulse">
                      <i class="bi bi-bell-fill"></i> {{ station.latestAlertSeverity }}
                    </span>
                    <span *ngIf="!station.hasActiveAlert" class="text-muted">—</span>
                  </td>
                  <td>
                    <div class="action-buttons">
                      <a [routerLink]="['/stations', station.stationId]" class="btn btn-icon btn-view" title="Voir détails">
                        <i class="bi bi-eye"></i>
                      </a>
                      <button class="btn btn-icon btn-compute" 
                              (click)="computeQuality(station.stationId)"
                              title="Recalculer la qualité">
                        <i class="bi bi-arrow-repeat"></i>
                      </button>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Active Alerts Panel -->
      <div class="col-lg-5 animate-fade-in-up">
        <div class="card alerts-panel-card">
          <div class="card-header alerts-header">
            <div class="d-flex align-items-center">
              <div class="alert-icon-pulse">
                <i class="bi bi-bell-fill"></i>
              </div>
              <h5>Alertes actives ({{ activeAlerts }})</h5>
            </div>
          </div>
          <div class="card-body alerts-body">
            <div *ngIf="alerts.length === 0" class="no-alerts">
              <div class="success-icon animate-scale-in">
                <i class="bi bi-shield-check"></i>
              </div>
              <h6>Tout est normal</h6>
              <p>Aucune alerte active</p>
            </div>
            
            <div *ngFor="let alert of alerts; let i = index" 
                 class="alert-item animate-fade-in-up" 
                 [style.animation-delay.ms]="i * 100"
                 [class]="'alert-severity-' + alert.severity?.toLowerCase()">
              <div class="alert-item-header">
                <span class="severity-badge" [class]="'severity-' + alert.severity?.toLowerCase()">
                  <i class="bi bi-exclamation-triangle-fill"></i>
                  {{ alert.severity }}
                </span>
                <span class="alert-time">
                  <i class="bi bi-clock"></i>
                  {{ alert.createdAt | date:'dd/MM HH:mm' }}
                </span>
              </div>
              <h6 class="alert-title">{{ alert.title }}</h6>
              <p class="alert-message">{{ alert.message }}</p>
              <div class="alert-item-footer">
                <span class="alert-meta">
                  <i class="bi bi-geo-alt"></i> Station #{{ alert.stationId }}
                  <span class="mx-2">|</span>
                  <i class="bi bi-speedometer2"></i> Score: {{ alert.score | number:'1.0-0' }}
                </span>
                <button class="btn btn-sm btn-acknowledge" (click)="acknowledgeAlert(alert.id)">
                  <i class="bi bi-check-lg"></i> Acquitter
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Model Info Section -->
  <div class="row mt-4">
    <div class="col-12 animate-fade-in-up">
      <div class="card model-info-card hover-lift">
        <div class="card-header model-header">
          <div class="d-flex align-items-center">
            <div class="model-icon">
              <i class="bi bi-cpu"></i>
            </div>
            <h5>À propos du modèle de prédiction</h5>
          </div>
        </div>
        <div class="card-body">
          <div class="row g-4">
            <div class="col-md-6">
              <div class="info-section">
                <h6><i class="bi bi-graph-up text-primary"></i> Calcul du Score WQI (Water Quality Index)</h6>
                <p>Le score de qualité est calculé selon les normes OMS en combinant:</p>
                <ul class="parameter-list">
                  <li><span class="param-name">pH</span><span class="param-value">optimal: 6.5-8.5</span><span class="param-weight">15%</span></li>
                  <li><span class="param-name">Température</span><span class="param-value">optimal: 15-25°C</span><span class="param-weight">10%</span></li>
                  <li><span class="param-name">Turbidité</span><span class="param-value">optimal: &lt;5 NTU</span><span class="param-weight">20%</span></li>
                  <li><span class="param-name">Oxygène dissous</span><span class="param-value">optimal: &gt;6 mg/L</span><span class="param-weight">25%</span></li>
                  <li><span class="param-name">Conductivité</span><span class="param-value">optimal: &lt;1000 µS/cm</span><span class="param-weight">15%</span></li>
                  <li><span class="param-name">Données satellite</span><span class="param-value">NDWI, turbidité</span><span class="param-weight">15%</span></li>
                </ul>
              </div>
            </div>
            <div class="col-md-6">
              <div class="info-section">
                <h6><i class="bi bi-lightning text-warning"></i> Prédiction & Alertes</h6>
                <p>Le système de prédiction utilise:</p>
                <ul class="feature-list">
                  <li><i class="bi bi-check2-circle text-success"></i><strong>Régression linéaire</strong> sur l'historique des observations</li>
                  <li><i class="bi bi-check2-circle text-success"></i><strong>Facteurs saisonniers</strong> (printemps, été, automne, hiver)</li>
                  <li><i class="bi bi-check2-circle text-success"></i><strong>Intervalles de confiance</strong> basés sur la variance historique</li>
                </ul>
                <div class="info-note">
                  <i class="bi bi-info-circle"></i>
                  Les alertes sont générées automatiquement quand le score passe sous 70 (modéré) ou 40 (mauvais).
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
