<div class="prediction-container">
  <!-- Page Header -->
  <div class="page-header animate-fade-in-down">
    <div class="header-content">
      <div class="header-icon animate-pulse">
        <i class="bi bi-calculator-fill"></i>
      </div>
      <div class="header-text">
        <h1>Prédiction de Qualité d'Eau</h1>
        <p>Calculez le score WQI à partir des paramètres de mesure</p>
      </div>
    </div>
  </div>

  <div class="content-grid">
    <!-- Form Column -->
    <div class="form-section animate-fade-in-up stagger-1">
      <div class="form-card">
        <div class="card-header">
          <i class="bi bi-sliders me-2"></i>
          Paramètres de Mesure
        </div>
        <div class="card-body">

          @if (error) {
            <div class="alert-error animate-fade-in">
              <i class="bi bi-exclamation-triangle-fill me-2"></i>{{ error }}
            </div>
          }

          <form [formGroup]="predictionForm" (ngSubmit)="onPredict()">
            <!-- Station Selection -->
            <div class="form-group station-select">
              <label for="stationId" class="form-label">
                <i class="bi bi-geo-alt me-1"></i> Station
              </label>
              @if (loadingStations) {
                <div class="loading-stations">
                  <span class="spinner-border spinner-border-sm me-2"></span>
                  Chargement des stations...
                </div>
              } @else {
                <select class="form-select" id="stationId" formControlName="stationId" (change)="onStationChange()">
                  @for (station of stations; track station.id) {
                    <option [value]="station.id">{{ station.code }} - {{ station.name }}</option>
                  }
                </select>
              }
            </div>

            <div class="params-divider">
              <span><i class="bi bi-droplet-half me-1"></i> Paramètres</span>
            </div>

            <div class="params-grid">
              <!-- pH -->
              <div class="param-input-group">
                <div class="param-icon ph">
                  <i class="bi bi-droplet-half"></i>
                </div>
                <div class="param-input">
                  <label for="ph">pH</label>
                  <input type="number" step="0.1" class="form-control" id="ph" formControlName="ph" placeholder="7.0">
                  <span class="ideal-range">Idéal: 6.5 - 8.5</span>
                </div>
              </div>

              <!-- Temperature -->
              <div class="param-input-group">
                <div class="param-icon temp">
                  <i class="bi bi-thermometer-half"></i>
                </div>
                <div class="param-input">
                  <label for="temperature">Température (°C)</label>
                  <input type="number" step="0.1" class="form-control" id="temperature" formControlName="temperature" placeholder="20.0">
                  <span class="ideal-range">Idéal: 15 - 25°C</span>
                </div>
              </div>

              <!-- Turbidity -->
              <div class="param-input-group">
                <div class="param-icon turbidity">
                  <i class="bi bi-water"></i>
                </div>
                <div class="param-input">
                  <label for="turbidity">Turbidité (NTU)</label>
                  <input type="number" step="0.1" class="form-control" id="turbidity" formControlName="turbidity" placeholder="3.0">
                  <span class="ideal-range">Idéal: &lt; 5 NTU</span>
                </div>
              </div>

              <!-- Dissolved Oxygen -->
              <div class="param-input-group">
                <div class="param-icon oxygen">
                  <i class="bi bi-wind"></i>
                </div>
                <div class="param-input">
                  <label for="dissolvedOxygen">Oxygène dissous (mg/L)</label>
                  <input type="number" step="0.1" class="form-control" id="dissolvedOxygen" formControlName="dissolvedOxygen" placeholder="8.0">
                  <span class="ideal-range">Idéal: &gt; 6 mg/L</span>
                </div>
              </div>

              <!-- Conductivity -->
              <div class="param-input-group">
                <div class="param-icon conductivity">
                  <i class="bi bi-lightning"></i>
                </div>
                <div class="param-input">
                  <label for="conductivity">Conductivité (µS/cm)</label>
                  <input type="number" step="1" class="form-control" id="conductivity" formControlName="conductivity" placeholder="500">
                  <span class="ideal-range">Idéal: 200 - 800 µS/cm</span>
                </div>
              </div>
            </div>

            <button type="submit" class="btn-predict" [disabled]="loading || loadingStations">
              @if (loading) {
                <span class="spinner-border spinner-border-sm me-2"></span>
                Calcul en cours...
              } @else {
                <i class="bi bi-lightning-charge-fill me-2"></i>Calculer la qualité
              }
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Result Column -->
    <div class="result-section animate-fade-in-up stagger-2">
      @if (result) {
        <div class="result-card animate-scale-in">
          <div class="result-header" [class]="'result-header-' + result.status?.toLowerCase()">
            <i class="bi bi-clipboard-data me-2"></i>
            Résultat de l'Analyse
          </div>
          <div class="result-body">
            <!-- Score Display -->
            <div class="score-display">
              <div class="score-circle" [class]="'score-' + result.status?.toLowerCase()">
                <span class="score-value">{{ result.score | number:'1.0-0' }}</span>
                <span class="score-max">/100</span>
              </div>
              <div class="status-label" [style.color]="getScoreColor(result.score)">
                {{ getStatusLabel(result.status) }}
              </div>
            </div>

            <!-- Station Info -->
            <div class="info-section">
              <div class="info-header">
                <i class="bi bi-geo-alt me-2"></i>Station
              </div>
              <div class="info-content">
                <strong>{{ result.stationName }}</strong>
                <span class="timestamp">
                  <i class="bi bi-clock me-1"></i>
                  {{ result.timestamp | date:'dd/MM/yyyy à HH:mm' }}
                </span>
              </div>
            </div>

            <!-- Parameters Used -->
            <div class="info-section">
              <div class="info-header">
                <i class="bi bi-list-check me-2"></i>Paramètres analysés
              </div>
              <div class="params-display">
                <div class="param-chip">
                  <label>pH</label>
                  <span>{{ result.parameters.ph }}</span>
                </div>
                <div class="param-chip">
                  <label>Temp</label>
                  <span>{{ result.parameters.temperature }}°C</span>
                </div>
                <div class="param-chip">
                  <label>Turbidité</label>
                  <span>{{ result.parameters.turbidity }} NTU</span>
                </div>
                <div class="param-chip">
                  <label>O₂</label>
                  <span>{{ result.parameters.dissolvedOxygen }} mg/L</span>
                </div>
                <div class="param-chip">
                  <label>Cond</label>
                  <span>{{ result.parameters.conductivity }} µS/cm</span>
                </div>
              </div>
            </div>

            <!-- Recommendations Section -->
            @if (result.recommendations && result.recommendations.length > 0) {
              <div class="info-section">
                <div class="info-header warning">
                  <i class="bi bi-lightbulb-fill me-2"></i>Recommandations
                </div>
                <div class="recommendations-list">
                  @for (recommendation of result.recommendations; track recommendation) {
                    <div class="recommendation-item">
                      <i class="bi bi-check-circle-fill"></i>
                      <span>{{ recommendation }}</span>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- Parameter Scores Section -->
            @if (result.parameterScores) {
              <div class="info-section">
                <div class="info-header">
                  <i class="bi bi-bar-chart-fill me-2"></i>Scores par paramètre
                </div>
                <div class="parameter-scores">
                  @for (param of ['ph', 'temperature', 'turbidity', 'dissolvedOxygen', 'conductivity']; track param) {
                    @if (result.parameterScores[param] !== undefined) {
                      <div class="score-bar-container">
                        <div class="score-bar-header">
                          <span class="param-name">{{ getParamLabel(param) }}</span>
                          <span class="param-score" [style.color]="getScoreColor(result.parameterScores[param])">
                            {{ result.parameterScores[param] | number:'1.0-0' }}/100
                          </span>
                        </div>
                        <div class="progress">
                          <div class="progress-bar" 
                               [style.width.%]="result.parameterScores[param]"
                               [style.background]="'linear-gradient(90deg, ' + getScoreColor(result.parameterScores[param]) + ', ' + getScoreColor(result.parameterScores[param]) + '80)'">
                          </div>
                        </div>
                      </div>
                    }
                  }
                </div>
              </div>
            }

            <!-- Actions -->
            <div class="result-actions">
              <a routerLink="/stations" class="btn-action btn-map">
                <i class="bi bi-map me-1"></i> Carte
              </a>
              <a routerLink="/dashboard" class="btn-action btn-dashboard">
                <i class="bi bi-speedometer2 me-1"></i> Dashboard
              </a>
            </div>
          </div>
        </div>
      } @else {
        <div class="empty-result animate-fade-in">
          <div class="empty-icon">
            <i class="bi bi-droplet-half"></i>
          </div>
          <h4>Aucune prédiction</h4>
          <p>Entrez les paramètres et cliquez sur "Calculer" pour obtenir une prédiction.</p>
        </div>
      }

      <!-- Info Card -->
      <div class="info-card animate-fade-in-up stagger-3">
        <div class="card-header info">
          <i class="bi bi-info-circle me-2"></i>
          Comment fonctionne le WQI ?
        </div>
        <div class="card-body">
          <p>L'indice de qualité de l'eau (WQI) est calculé à partir de plusieurs paramètres :</p>
          <ul class="wqi-list">
            <li><span class="param-dot ph"></span><strong>pH</strong> : Mesure de l'acidité/alcalinité</li>
            <li><span class="param-dot temp"></span><strong>Température</strong> : Affecte la vie aquatique</li>
            <li><span class="param-dot turbidity"></span><strong>Turbidité</strong> : Clarté de l'eau</li>
            <li><span class="param-dot oxygen"></span><strong>Oxygène dissous</strong> : Vital pour les organismes</li>
            <li><span class="param-dot conductivity"></span><strong>Conductivité</strong> : Concentration en minéraux</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- History Section -->
  <div class="history-section animate-fade-in-up stagger-4">
    <div class="history-card">
      <div class="card-header">
        <div class="header-left">
          <i class="bi bi-clock-history me-2"></i>
          Historique des Prédictions
        </div>
        @if (predictionHistory.length > 0) {
          <span class="history-count">{{ predictionHistory.length }} prédiction(s)</span>
        }
      </div>
      <div class="card-body">
        @if (loadingHistory) {
          <div class="loading-history">
            <div class="loading-spinner">
              <div class="spinner-ring"></div>
              <div class="spinner-ring"></div>
              <i class="bi bi-clock-history spinner-icon"></i>
            </div>
            <p>Chargement de l'historique...</p>
          </div>
        } @else if (predictionHistory.length === 0) {
          <div class="empty-history">
            <i class="bi bi-inbox"></i>
            <p>Aucune prédiction dans l'historique pour cette station.</p>
          </div>
        } @else {
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Score</th>
                  <th>Status</th>
                  <th>pH</th>
                  <th>Temp (°C)</th>
                  <th>Turbidité</th>
                  <th>O₂ (mg/L)</th>
                  <th>Cond. (µS/cm)</th>
                </tr>
              </thead>
              <tbody>
                @for (item of predictionHistory; track item.id; let i = $index) {
                  <tr class="table-row-animated" [style.animation-delay.ms]="i * 50">
                    <td class="date-cell">{{ item.predictionTimestamp | date:'dd/MM/yyyy HH:mm' }}</td>
                    <td>
                      <span class="score-badge" [style.color]="getScoreColor(item.score)">
                        {{ item.score | number:'1.1-1' }}
                      </span>
                    </td>
                    <td>
                      <span class="status-badge" [class]="'status-' + item.status?.toLowerCase()">
                        {{ getStatusLabel(item.status) }}
                      </span>
                    </td>
                    <td class="param-cell">{{ item.ph | number:'1.1-1' }}</td>
                    <td class="param-cell">{{ item.temperature | number:'1.1-1' }}</td>
                    <td class="param-cell">{{ item.turbidity | number:'1.1-1' }}</td>
                    <td class="param-cell">{{ item.dissolvedOxygen | number:'1.1-1' }}</td>
                    <td class="param-cell">{{ item.conductivity | number:'1.0-0' }}</td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        }
      </div>
    </div>
  </div>
</div>
